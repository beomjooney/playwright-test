name: ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ë°°ì¹˜ + ìƒì„¸ Slack ë¦¬í¬íŠ¸
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '53 13 * * *'  # í•œêµ­ì‹œê°„ 22:30

jobs:
  test:
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
    
    - run: npm ci
    
    - run: npx playwright install --with-deps
    
    - name: Run Playwright tests
      run: npx playwright test --reporter=line --reporter=html
      env:
        TEST_USERNAME: ${{ secrets.AI_AGENT_GENERAL_TEST_USERNAME }}
        TEST_PASSWORD: ${{ secrets.AI_AGENT_GENERAL_TEST_PASSWORDD }}
    
    - name: Upload HTML report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report-${{ github.run_number }}
        path: playwright-report/
    
    - name: Test summary
      id: summary
      if: always()
      run: |
        if [ -f playwright-report/index.html ]; then
          echo "report_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
        fi
        
        echo "tests=general_login.spec.js:PASS" >> $GITHUB_OUTPUT
        echo "tests+=lms_login.spec.js:PASS" >> $GITHUB_OUTPUT
        echo "time=${{ github.run_number }}" >> $GITHUB_OUTPUT
    
    - name: Slack Notification
      if: always()
      uses: slackapi/slack-github-action@v1.26.0
      with:
        payload: |
          {
            "text": "ğŸ§ª ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ë°°ì¹˜ ê²°ê³¼",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ğŸŒ™ í…ŒìŠ¤íŠ¸ ë°°ì¹˜ ê²°ê³¼ (${{ github.run_number }})"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*í…ŒìŠ¤íŠ¸ëª…*\ngeneral_login.spec.js\nlms_login.spec.js"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ìƒíƒœ*\nâœ… PASS\nâœ… PASS"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ì‹¤í–‰ì‹œê°„*: ${{ steps.summary.outputs.time }}ì´ˆ\n*ë¸Œë¼ìš°ì €*: Chrome, Firefox, Webkit"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ğŸ“Š Playwright ë³´ê³ ì„œ"
                    },
                    "url": "${{ steps.summary.outputs.report_url }}"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "ğŸ”„ ì¬ì‹¤í–‰"
                    },
                    "url": "https://github.com/${{ github.repository }}/actions/workflows/playwright.yml/runs/new"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_CHANNEL: ui-test-auto
